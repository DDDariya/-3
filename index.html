<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Гостевая книга на JavaScript</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --muted:#6b7280; --text:#e5e7eb; --acc:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --border:#1f2937;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{flex:1 1 240px;display:flex;flex-direction:column;gap:6px}
    label{font-weight:600}
    input[type="text"], textarea{background:#0b1020;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px;outline:none}
    textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{border:1px solid var(--border);background:#0b1222;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{background:linear-gradient(90deg,#0ea5e9,#22c55e)}
    button.link{background:transparent;border:none;color:#93c5fd;text-decoration:underline;padding:0}
    .toggle-replies{background:transparent;border:none;color:#93c5fd;text-decoration:underline;padding:0;cursor:pointer}
    .muted{color:var(--muted);font-size:12px}
    .error{color:var(--danger);font-weight:600}
    .warn{color:var(--warn);font-weight:600}
    .comment{border-left:2px solid #243244; padding-left:12px; margin-top:14px}
    .comment .meta{display:flex;gap:10px;align-items:center;font-size:13px;color:#9ca3af}
    .comment .text{margin:6px 0 10px 0;white-space:pre-wrap}
    .comment .toolbar{display:flex;gap:12px}
    .children{margin-left:18px}
    .children.is-collapsed{display:none}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1222;border:1px solid var(--border);font-size:12px}
    .hr{height:1px;background:var(--border);margin:16px 0}
    .right{margin-left:auto}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0b1222;border:1px solid var(--border);border-radius:6px;padding:1px 6px;font-size:12px}
    .hidden{position:absolute;left:-10000px;opacity:0;pointer-events:none}
    .capcha{display:flex;gap:8px;align-items:center}
    .capcha .question{font-weight:600}
    .badge{padding:2px 8px;border-radius:8px;border:1px solid var(--border);background:#0b1222;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Гостевая книга</h1>
    <p class="muted">Хранилище: <span id="storage-mode" class="badge">localStorage</span></p>

    <div class="card" id="form-card">
      <form id="comment-form" autocomplete="off" novalidate>
        <div class="row">
          <div class="field">
            <label for="author">Ваше имя</label>
            <input type="text" id="author" maxlength="60" placeholder="Например: Анна" required />
          </div>
          <div class="field">
            <label for="email">Email (необязательно)</label>
            <input type="text" id="email" maxlength="120" placeholder="user@example.org" />
          </div>
        </div>

        <div class="field" style="margin-top:8px">
          <label for="comment">Комментарий</label>
          <textarea id="comment" maxlength="2000" placeholder="Ваше сообщение..." required></textarea>
          <div class="muted">Осталось символов: <span id="chars-left">2000</span></div>
        </div>

        <!-- honeypot -->
        <input type="text" id="website" class="hidden" tabindex="-1" aria-hidden="true" autocomplete="off" />

        <div class="row" style="margin-top:8px">
          <div class="field" style="max-width:280px">
            <label>Капча</label>
            <div class="capcha">
              <span class="question" id="captcha-q">1 + 2 = ?</span>
              <input type="text" id="captcha-a" inputmode="numeric" pattern="[0-9]*" placeholder="Ответ" maxlength="3" />
            </div>
          </div>
          <div class="field" style="max-width:260px">
            <label>&nbsp;</label>
            <div class="actions">
              <button type="submit" id="submit" class="primary">Отправить</button>
              <span class="muted">⌛ Лимит: одно сообщение раз в <span class="kbd">59с</span></span>
            </div>
          </div>
        </div>
        <div id="form-error" class="error" role="alert" style="margin-top:6px"></div>
        <div id="form-warn" class="warn" style="margin-top:6px"></div>
        <input type="hidden" id="parentId" value="" />
      </form>
    </div>

    <div class="hr"></div>

    <div class="row" style="align-items:center">
      <h2 style="margin:0">Комментарии</h2>
      <span class="right pill" id="count-pill">0</span>
      <button class="link right" id="export-btn" title="Экспорт JSON">Экспорт</button>
      <label for="import-file" class="link" style="cursor:pointer">Импорт</label>
      <input id="import-file" type="file" accept="application/json" class="hidden" />
    </div>

    <div id="comments-root" style="margin-top:8px"></div>
  </div>

  <script>
  (function(){
    // ====== Конфигурация ======
    const RATE_LIMIT_SECONDS = 59;                  // ограничение частоты
    const STOP_WORDS = ["<script", "http://", "https://"]; // простой фильтр
    const MAX_CHILD_DEPTH = 4;                      // максимальная глубина ответов

    // ====== Утилиты ======
    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

    const storageKey = 'guestbook.comments.v1';
    const lastSubmitKey = 'guestbook.lastSubmitAt';
    const collapsedKey = 'guestbook.collapsed.v1';

    const escapeHtml = (s='') => s
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');

    const nowTs = () => Math.floor(Date.now()/1000);
    function genId(){ return 'c_'+Math.random().toString(36).slice(2,9)+Date.now().toString(36); }

    function readAll(){
      try { return JSON.parse(localStorage.getItem(storageKey)||'[]'); }
      catch(e){ console.warn(e); return []; }
    }
    function writeAll(list){ localStorage.setItem(storageKey, JSON.stringify(list)); }
    function byId(list,id){ return list.find(x=>x.id===id); }

    function buildTree(flat){
      const map=new Map(); flat.forEach(c=>map.set(c.id,{...c,children:[]}));
      const roots=[];
      map.forEach(node=>{
        if(node.parentId && map.has(node.parentId)) map.get(node.parentId).children.push(node);
        else roots.push(node);
      });
      return roots;
    }
    function calcDepth(map, id){
      let d=0; let cur = map.get(id);
      while(cur && cur.parentId && map.get(cur.parentId)){ d++; cur = map.get(cur.parentId); if(d>32)break; }
      return d;
    }
    function humanDate(ts){
      const d = new Date(ts);
      return d.toLocaleString('ru-RU');
    }

    // ====== Капча ======
    function newCaptcha(){
      const a = Math.floor(Math.random()*9)+1;
      const b = Math.floor(Math.random()*9)+1;
      const op = Math.random()<0.5 ? '+' : '−';
      const result = op==='+' ? a+b : a-b;
      $('#captcha-q').textContent = `${a} ${op} ${b} = ?`;
      $('#captcha-q').dataset.answer = String(result);
      $('#captcha-a').value='';
    }

    // ====== Состояние свёрнутых веток ======
    function loadCollapsed(){
      try { return new Set(JSON.parse(localStorage.getItem(collapsedKey) || '[]')); }
      catch { return new Set(); }
    }
    function saveCollapsed(set){
      localStorage.setItem(collapsedKey, JSON.stringify(Array.from(set)));
    }
    let collapsed = loadCollapsed();

    // ====== Рендер ======
    function render(){
      const flat = readAll().sort((a,b)=>a.createdAt-b.createdAt);
      $('#count-pill').textContent = String(flat.length);
      const root = $('#comments-root');
      root.innerHTML='';
      const tree = buildTree(flat);
      tree.forEach(n => root.appendChild(renderNode(n, 0)));
    }

    function renderNode(node, depth){
      const el = document.createElement('div');
      el.className = 'comment';
      el.dataset.id = node.id;

      const meta = document.createElement('div');
      meta.className='meta';
      meta.innerHTML = `<span class="badge">#${escapeHtml(node.author||'Аноним')}</span>
                        <span class="muted">${humanDate(node.createdAt)}</span>`;
      el.appendChild(meta);

      const text = document.createElement('div');
      text.className='text';
      text.innerHTML = escapeHtml(node.text);
      el.appendChild(text);

      const toolbar = document.createElement('div');
      toolbar.className='toolbar';

      const replyBtn = document.createElement('button');
      replyBtn.className='link'; replyBtn.textContent='Ответить';
      replyBtn.addEventListener('click', ()=>startReply(node.id, depth));
      toolbar.appendChild(replyBtn);

      const editBtn = document.createElement('button');
      editBtn.className='link'; editBtn.textContent='Редактировать';
      editBtn.addEventListener('click', ()=>startEdit(node.id));
      toolbar.appendChild(editBtn);

      const delBtn = document.createElement('button');
      delBtn.className='link'; delBtn.textContent='Удалить';
      delBtn.addEventListener('click', ()=>removeComment(node.id));
      toolbar.appendChild(delBtn);

      el.appendChild(toolbar);

      const kidsWrap = document.createElement('div');
      kidsWrap.className='children';

      if(node.children && node.children.length){
        const isCollapsed = collapsed.has(node.id);
        if(isCollapsed) kidsWrap.classList.add('is-collapsed');

        const toggle = document.createElement('button');
        toggle.className = 'toggle-replies';
        const setToggleText = ()=>{
          toggle.textContent = (collapsed.has(node.id) ? 'Показать ответы' : 'Скрыть ответы') + ` (${node.children.length})`;
        };
        setToggleText();
        toggle.addEventListener('click', ()=>{
          if(collapsed.has(node.id)) collapsed.delete(node.id);
          else collapsed.add(node.id);
          saveCollapsed(collapsed);
          kidsWrap.classList.toggle('is-collapsed');
          setToggleText();
        });
        el.appendChild(toggle);

        node.children.forEach(ch=>kidsWrap.appendChild(renderNode(ch, depth+1)));
      }
      el.appendChild(kidsWrap);

      return el;
    }

    // ====== Действия ======
    function startReply(parentId, depth){
      const warn = $('#form-warn');
      const error = $('#form-error');
      error.textContent = '';
      if(depth >= MAX_CHILD_DEPTH){
        warn.textContent = `Достигнута максимальная глубина ответов (${MAX_CHILD_DEPTH}).`;
        return;
      }
      warn.textContent = `Режим ответа: сообщение будет вложено. [id=${parentId}]`;
      $('#parentId').value = parentId;
      $('#author').focus();
      scrollToForm();
    }

    function startEdit(id){
      const list = readAll();
      const c = byId(list, id);
      if(!c) return;
      $('#form-warn').textContent = `Режим редактирования комментария [id=${id}]`;
      $('#parentId').value = id + '::edit';
      $('#author').value = c.author || '';
      $('#email').value = c.email || '';
      $('#comment').value = c.text || '';
      updateCounter();
      scrollToForm();
    }

    function removeComment(id){
      if(!confirm('Удалить это сообщение?')) return;
      const flat = readAll();
      const map = new Map(flat.map(x=>[x.id,x]));
      const toDelete = new Set([id]);
      let changed = true;
      while(changed){
        changed=false;
        flat.forEach(x=>{ if(x.parentId && toDelete.has(x.parentId) && !toDelete.has(x.id)){ toDelete.add(x.id); changed=true; }});
      }
      const rest = flat.filter(x=>!toDelete.has(x.id));
      writeAll(rest);
      render();
    }

    function scrollToForm(){
      $('#form-card').scrollIntoView({behavior:'smooth', block:'start'});
    }

    // ====== Импорт/экспорт ======
    $('#export-btn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(readAll(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'guestbook-export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#import-file').addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(!Array.isArray(data)) throw new Error('Неверный формат');
          const cleaned = data.filter(x => x && typeof x.id==='string' && typeof x.text==='string');
          writeAll(cleaned);
          // сбрасываем сохранённые свёрнутые ветки, чтобы не было «битых» ссылок
          collapsed = new Set(); saveCollapsed(collapsed);
          render();
          alert('Импорт завершён.');
        }catch(err){ alert('Ошибка импорта: '+err.message); }
      };
      reader.readAsText(f);
    });

    // ====== Форма отправки ======
    const form = $('#comment-form');
    const authorEl = $('#author');
    const emailEl = $('#email');
    const commentEl = $('#comment');
    const parentEl = $('#parentId');
    const hpEl = $('#website');
    const errEl = $('#form-error');
    const warnEl = $('#form-warn');
    const charsLeft = $('#chars-left');

    function updateCounter(){
      const max = parseInt(commentEl.getAttribute('maxlength'),10);
      const left = max - commentEl.value.length;
      charsLeft.textContent = String(left);
    }
    commentEl.addEventListener('input', updateCounter);

    form.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      errEl.textContent=''; warnEl.textContent='';

      if(hpEl.value.trim()!==''){ errEl.textContent='Подозрение на спам.'; return; }

      const last = parseInt(localStorage.getItem(lastSubmitKey)||'0',10);
      if(nowTs() - last < RATE_LIMIT_SECONDS){
        errEl.textContent = `Слишком часто. Подождём ${RATE_LIMIT_SECONDS - (nowTs()-last)} с.`;
        return;
      }

      const ans = $('#captcha-q').dataset.answer || '';
      if(($('#captcha-a').value||'').trim() !== ans){
        errEl.textContent = 'Неверный ответ на капчу.';
        newCaptcha();
        return;
      }

      const author = (authorEl.value||'').trim().slice(0,60);
      const email = (emailEl.value||'').trim().slice(0,120);
      const textRaw = (commentEl.value||'').trim();

      if(author.length<2) { errEl.textContent='Имя должно быть не короче 2 символов.'; return; }
      if(textRaw.length<3) { errEl.textContent='Комментарий должен быть не короче 3 символов.'; return; }
      if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ errEl.textContent='Некорректный email.'; return; }

      const lower = textRaw.toLowerCase();
      if(STOP_WORDS.some(w => lower.includes(w))){
        errEl.textContent = 'Сообщение содержит запрещённые конструкции/ссылки.';
        return;
      }

      const pidRaw = parentEl.value;
      const isEdit = pidRaw.endsWith('::edit');
      const editId = isEdit ? pidRaw.split('::')[0] : null;
      const parentId = (!pidRaw || isEdit) ? null : pidRaw;

      const flat = readAll();
      const map = new Map(flat.map(x=>[x.id,x]));
      if(parentId){
        const depth = calcDepth(map, parentId);
        if(depth >= MAX_CHILD_DEPTH){
          errEl.textContent = `Достигнута максимальная глубина ответов (${MAX_CHILD_DEPTH}).`;
          return;
        }
      }

      if(isEdit){
        const item = byId(flat, editId);
        if(!item){ errEl.textContent='Комментарий для редактирования не найден.'; return; }
        item.author = author;
        item.email = email;
        item.text = textRaw;
        item.updatedAt = Date.now();
        writeAll(flat);
      } else {
        const newItem = {
          id: genId(),
          parentId: parentId,
          author,
          email,
          text: textRaw,
          createdAt: Date.now()
        };
        flat.push(newItem);
        writeAll(flat);
      }

      authorEl.value=''; emailEl.value=''; commentEl.value='';
      parentEl.value='';
      $('#captcha-a').value='';
      updateCounter();
      localStorage.setItem(lastSubmitKey, String(nowTs()));
      newCaptcha();
      render();
    });

    // ====== Инициализация ======
    function boot(){
      $('#storage-mode').textContent = 'localStorage';
      newCaptcha();
      updateCounter();
      render();
    }
    boot();

    // ====== Точка расширения под сервер (опционально) ======
    window.guestbookApi = {
      async list(){ return readAll(); },
      async create(payload){ const all=readAll(); all.push(payload); writeAll(all); return payload; }
    };
  })();
  </script>
</body>
</html>
